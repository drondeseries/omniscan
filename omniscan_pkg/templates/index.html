<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Omniscan Dashboard</title><script src="https://cdn.tailwindcss.com"></script><script src="https://cdn.jsdelivr.net/npm/chart.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"><style>@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');body{font-family:'Inter',sans-serif;background:#080a10;color:#e2e8f0}.sidebar{background:#0c111d;border-right:1px solid #1e293b}.card{background:#111827;border:1px solid #1f2937;transition:all 0.2s}.card:hover{border-color:#374151;transform:translateY(-2px)}.nav-link{color:#94a3b8;border-radius:12px;transition:all 0.2s}.nav-link.active{color:#fff;background:#1e293b}.nav-link:hover:not(.active){background:#111827;color:#fff}.mobile-nav-link{color:#94a3b8;display:flex;flex-direction:column;align-items:center;padding:8px;border-radius:12px}.mobile-nav-link.active{color:#0ea5e9;background:rgba(14,165,233,0.1)}input,select,textarea{background:#111827!important;border:1px solid #374151!important;color:#fff!important;border-radius:12px!important}input:focus,textarea:focus{border-color:#0ea5e9!important}.glass{background:rgba(17,24,39,0.7);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,0.05)}</style></head><body class="flex min-h-screen overflow-hidden"><aside class="sidebar w-72 flex-shrink-0 flex flex-col hidden lg:flex"><div class="p-8 flex items-center gap-4"><img src="/assets/logo.png" class="w-12 h-12 rounded-2xl shadow-blue-500/20 shadow-lg" alt="Logo"><div><h1 class="font-bold text-2xl tracking-tight">Omniscan</h1><div class="flex items-center gap-1.5 mt-0.5"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span><span class="text-[10px] text-slate-500 font-black uppercase">Active</span></div></div></div><nav class="mt-8 px-4 flex-grow space-y-2"><button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-link active w-full flex items-center gap-4 px-6 py-4 text-sm font-semibold"><i class="fas fa-chart-line w-5"></i> Dashboard</button><button onclick="switchTab('health')" id="nav-health" class="nav-link w-full flex items-center gap-4 px-6 py-4 text-sm font-semibold"><i class="fas fa-heart-pulse w-5"></i> Health</button><button onclick="switchTab('history')" id="nav-history" class="nav-link w-full flex items-center gap-4 px-6 py-4 text-sm font-semibold"><i class="fas fa-history w-5"></i> History</button><button onclick="switchTab('logs')" id="nav-logs" class="nav-link w-full flex items-center gap-4 px-6 py-4 text-sm font-semibold"><i class="fas fa-terminal w-5"></i> Live Logs</button><button onclick="switchTab('browser')" id="nav-browser" class="nav-link w-full flex items-center gap-4 px-6 py-4 text-sm font-semibold"><i class="fas fa-folder-tree w-5"></i> Browser</button><button onclick="switchTab('settings')" id="nav-settings" class="nav-link w-full flex items-center gap-4 px-6 py-4 text-sm font-semibold"><i class="fas fa-sliders w-5"></i> Settings</button><a href="/logout" class="nav-link w-full flex items-center gap-4 px-6 py-4 text-sm font-semibold text-red-400/70 hover:text-red-400"><i class="fas fa-right-from-bracket w-5"></i> Sign Out</a></nav><div class="p-8"><div class="card p-5 rounded-[2rem]"><div class="flex justify-between items-center mb-3"><p class="text-[10px] text-slate-500 uppercase font-black">Server Link</p><button onclick="checkServer()" id="btn-check-server" class="text-blue-400 hover:text-white transition-colors"><i class="fas fa-rotate"></i></button></div><div class="flex items-center justify-between"><span id="provider-name" class="text-sm font-bold text-white italic">Plex</span><span id="server-status" class="text-green-500 text-[10px] font-bold uppercase">Stable</span></div></div></div></aside><main class="flex-grow flex flex-col h-screen overflow-hidden relative pb-20 lg:pb-0"><header class="h-16 lg:h-20 border-b border-slate-800/50 flex items-center justify-between px-6 lg:px-10 glass sticky top-0 z-20"><h2 id="page-title" class="font-extrabold text-xl">Dashboard</h2><div class="flex items-center gap-4"><button id="btn-scan-all" onclick="triggerFullScan()" class="hidden md:flex items-center gap-2 bg-blue-500/10 hover:bg-blue-500 text-blue-400 hover:text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest border border-blue-500/20 transition-all"><i class="fas fa-bolt"></i> Run Full Scan</button><div class="flex flex-col items-end"><span class="text-[10px] text-slate-500 font-bold uppercase">Uptime</span><span id="uptime" class="text-sm font-mono text-blue-400 font-bold">00:00:00</span></div></div></header><div id="content-scroll" class="flex-grow overflow-y-auto p-4 lg:p-10"><div id="view-dashboard" class="space-y-6"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="card p-8 rounded-3xl"><div><p class="text-slate-500 text-[10px] font-black uppercase">Watching</p></div><h3 id="watching-count" class="text-4xl font-black mt-4">--</h3></div><div class="card p-8 rounded-3xl"><div><p class="text-slate-500 text-[10px] font-black uppercase">Queue</p></div><h3 id="pending-count" class="text-4xl font-black mt-4">0</h3></div><div class="card p-8 rounded-3xl"><div><p class="text-slate-500 text-[10px] font-black uppercase">Health Checks</p></div><h3 id="health-check-count" class="text-4xl font-black mt-4">--</h3></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="card p-6 rounded-3xl flex items-center justify-center relative min-h-[200px]"><canvas id="healthChart"></canvas><div class="absolute inset-0 flex items-center justify-center pointer-events-none"><div class="text-center mt-2"><span id="chart-total" class="text-2xl font-black text-white block">0</span><span class="text-[9px] uppercase font-bold text-slate-500">Total</span></div></div></div><div class="grid grid-cols-2 gap-4"><div onclick="filterHealth('Healthy')" class="card p-5 rounded-2xl border-l-4 border-green-500 cursor-pointer hover:bg-slate-800 transition-colors"><div><p id="stat-healthy" class="text-lg font-black">0</p><p class="text-[9px] text-slate-500 font-black uppercase">Healthy</p></div></div><div onclick="filterHealth('Corrupt')" class="card p-5 rounded-2xl border-l-4 border-red-500 cursor-pointer hover:bg-slate-800 transition-colors"><div><p id="stat-corrupt" class="text-lg font-black">0</p><p class="text-[9px] text-slate-500 font-black uppercase">Corrupt</p></div></div><div onclick="filterHealth('Timeout')" class="card p-5 rounded-2xl border-l-4 border-orange-500 cursor-pointer hover:bg-slate-800 transition-colors"><div><p id="stat-timeout" class="text-lg font-black">0</p><p class="text-[9px] text-slate-500 font-black uppercase">Timeouts</p></div></div><div class="card p-5 rounded-2xl border-l-4 border-blue-500"><div><p id="stat-integrity" class="text-lg font-black">0%</p><p class="text-[9px] text-slate-500 font-black uppercase">Integrity</p></div></div></div></div><div id="storage-container" class="grid grid-cols-1 gap-4"></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2"><h4 class="text-[10px] font-black text-slate-500 uppercase mb-4">Active Queue</h4><div id="queue-list" class="space-y-2"></div></div><div class="space-y-4"><h4 class="text-[10px] font-black text-slate-500 uppercase">Libraries</h4><div id="libraries-list" class="space-y-2"></div><h4 class="text-[10px] font-black text-slate-500 uppercase mt-6">Watching</h4><div id="watching-list" class="space-y-2"></div></div></div></div><div id="view-health" class="hidden"><div class="card p-6 rounded-3xl"><h4 class="text-lg font-bold mb-6">Recent Results</h4><div id="health-list" class="space-y-2"></div></div></div><div id="view-history" class="hidden"><div class="card p-6 rounded-3xl"><div class="flex items-center justify-between mb-6 flex-wrap gap-4"><h4 class="text-lg font-bold">Event History</h4><div class="flex gap-2 items-center"><button onclick="clearHistory(this)" class="bg-red-500/10 text-red-400 p-2 rounded-lg text-xs font-bold hover:bg-red-500 hover:text-white transition-colors"><i class="fas fa-trash"></i></button><select id="history-filter" class="px-4 py-2 text-xs w-32 font-bold" onchange="loadHistory(document.getElementById('history-search').value)"><option value="">All Events</option><option value="Health Check">Health</option><option value="Scan">Scans</option><option value="Error">Errors</option></select><input type="text" id="history-search" placeholder="Search..." class="px-4 py-2 text-xs w-48"></div></div><div class="overflow-x-auto"><table class="w-full text-left text-sm text-slate-400"><thead><tr class="text-[10px] uppercase bg-slate-900/50 text-slate-300"><th class="px-6 py-4">Time</th><th class="px-6 py-4">Event</th><th class="px-6 py-4">Details</th><th class="px-6 py-4">Status</th></tr></thead><tbody id="history-table-body"></tbody></table></div><div id="history-more" class="p-6 text-center hidden"><button onclick="loadHistory(document.getElementById('history-search').value, true)" class="text-blue-400 text-[10px] font-black uppercase">Load More</button></div></div></div><div id="view-browser" class="hidden"><div class="card p-5 rounded-2xl mb-4 flex flex-col md:flex-row gap-4 justify-between items-center"><div class="flex items-center gap-4 w-full md:w-auto"><p id="browser-current-path" class="text-xs font-mono text-blue-400 truncate max-w-[200px] md:max-w-md">Root</p><button onclick="loadBrowser(browserPath)" class="w-8 h-8 rounded-lg bg-blue-500/10 text-blue-400 flex-shrink-0"><i class="fas fa-sync-alt"></i></button></div><div class="flex gap-2 w-full md:w-auto"><input type="text" id="browser-search-input" placeholder="Jump to path..." class="flex-grow md:w-64 px-4 py-2 text-xs font-mono" onkeyup="if(event.key==='Enter')window.searchBrowser()"><button onclick="window.searchBrowser()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold uppercase transition-all flex items-center gap-2"><i class="fas fa-search"></i> Go</button></div></div><div id="browser-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div></div><div id="view-logs" class="hidden h-[calc(100vh-140px)] flex flex-col"><div class="card rounded-2xl flex-grow overflow-hidden flex flex-col border border-slate-800 bg-[#0a0e17]"><div class="p-4 border-b border-slate-800 flex justify-between items-center bg-[#0d121f]"><div class="flex items-center gap-2"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span><span class="text-xs font-mono text-slate-400 font-bold">LIVE STREAM</span></div><button onclick="document.getElementById('log-terminal').innerHTML=''" class="text-[10px] uppercase font-black text-slate-500 hover:text-white transition-colors">Clear</button></div><div id="log-terminal" class="flex-grow overflow-y-auto p-4 font-mono text-[10px] space-y-1 text-slate-300 scroll-smooth font-medium"></div></div></div><div id="view-settings" class="hidden pb-40"><form id="settings-form" class="space-y-8"><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div onclick="window.selectP('plex')" id="c-plex" class="card p-6 rounded-2xl text-center cursor-pointer border-2 border-transparent">Plex</div><div onclick="window.selectP('jellyfin')" id="c-jellyfin" class="card p-6 rounded-2xl text-center cursor-pointer border-2 border-transparent">Jellyfin</div><div onclick="window.selectP('emby')" id="c-emby" class="card p-6 rounded-2xl text-center cursor-pointer border-2 border-transparent">Emby</div></div><input type="hidden" id="s-type"><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="card p-6 rounded-2xl space-y-4"><div><label class="block text-[10px] font-black uppercase mb-1">Plex URL</label><input type="text" id="s-p-url" class="w-full p-3"></div><div><label class="block text-[10px] font-black uppercase mb-1">Token</label><input type="password" id="s-p-token" class="w-full p-3"></div><div id="f-gen" class="hidden"><div><label class="block text-[10px] font-black uppercase mb-1">Server URL</label><input type="text" id="s-url" class="w-full p-3"></div><div><label class="block text-[10px] font-black uppercase mb-1">API Key</label><input type="password" id="s-key" class="w-full p-3"></div></div><div class="pt-2"><button type="button" onclick="testConnection()" class="w-full bg-blue-500/10 hover:bg-blue-500 text-blue-400 hover:text-white px-4 py-3 rounded-xl text-xs font-bold uppercase transition-all">Test Connection</button></div></div><div class="card p-6 rounded-2xl space-y-4"><div class="flex justify-between items-center"><label class="block text-[10px] font-black uppercase mb-1">Scan Paths</label><button type="button" onclick="verifyPaths()" class="text-[9px] text-blue-400 font-bold uppercase hover:text-white">Verify Paths</button></div><textarea id="s-dirs" rows="3" class="w-full p-3"></textarea><div id="path-errors" class="space-y-1 mt-2"></div><div class="grid grid-cols-2 gap-4 pt-2"><div><label class="block text-[10px] font-black uppercase mb-1">Debounce</label><input type="number" id="s-deb" class="w-full p-3"></div><div><label class="block text-[10px] font-black uppercase mb-1">Workers</label><input type="number" id="s-work" class="w-full p-3"></div></div></div><div class="card p-6 rounded-2xl space-y-4"><div><h3 class="font-bold mb-4">Discord Alerts</h3><div class="flex items-center gap-2 mb-3"><input type="checkbox" id="s-notifs" class="w-4 h-4"><label class="text-xs">Enable Notifications</label></div><div class="flex gap-2"><input type="text" id="s-webhook" placeholder="Webhook URL" class="w-full p-3 text-xs"><button type="button" onclick="testDiscord()" class="bg-indigo-500/20 text-indigo-400 px-4 rounded-xl font-bold text-xs hover:bg-indigo-500 hover:text-white">Test</button></div></div></div></div><div class="card p-6 rounded-2xl space-y-4"><div><h3 class="font-bold mb-4">Scanning Behavior</h3><div class="grid grid-cols-2 gap-4"><div><label class="block text-[10px] font-black uppercase mb-1">Run Interval (Hours)</label><input type="number" id="s-interval" class="w-full p-3"></div><div><label class="block text-[10px] font-black uppercase mb-1">Scan Since (Days)</label><input type="number" id="s-since" class="w-full p-3"></div></div><div class="grid grid-cols-2 gap-4 mt-3"><div class="flex items-center gap-2"><input type="checkbox" id="s-startup" class="w-4 h-4"><label class="text-xs">Run on Startup</label></div><div class="flex items-center gap-2"><input type="checkbox" id="s-inc" class="w-4 h-4"><label class="text-xs">Incremental Scan</label></div></div></div></div><div class="card p-6 rounded-2xl space-y-4"><div><h3 class="font-bold mb-4">Health Checks</h3><div class="grid grid-cols-2 gap-4"><div><label class="block text-[10px] font-black uppercase mb-1">Min Duration (Sec)</label><input type="number" id="s-duration" class="w-full p-3"></div><div class="flex flex-col justify-center gap-2"><div class="flex items-center gap-2"><input type="checkbox" id="s-health" class="w-4 h-4"><label class="text-xs">Enable Health Check</label></div><div class="flex items-center gap-2"><input type="checkbox" id="s-symlink" class="w-4 h-4"><label class="text-xs">Check Symlinks</label></div><div class="flex items-center gap-2"><input type="checkbox" id="s-samples" class="w-4 h-4"><label class="text-xs">Ignore Samples</label></div></div></div></div></div><div class="card p-6 rounded-2xl space-y-4"><div><h3 class="font-bold mb-4">Advanced</h3><div class="grid grid-cols-2 gap-4"><div><label class="block text-[10px] font-black uppercase mb-1">Start Time (HH:MM)</label><input type="text" id="s-start-time" class="w-full p-3" placeholder="00:00"></div><div><label class="block text-[10px] font-black uppercase mb-1">Scan Delay (Sec)</label><input type="number" id="s-delay" step="0.1" class="w-full p-3"></div></div><div class="grid grid-cols-2 gap-4 mt-3"><div><label class="block text-[10px] font-black uppercase mb-1">Log Level</label><select id="s-loglevel" class="w-full p-3"><option value="DEBUG">DEBUG</option><option value="INFO">INFO</option><option value="WARNING">WARNING</option><option value="ERROR">ERROR</option></select></div><div class="flex items-center gap-2 mt-4"><input type="checkbox" id="s-poll" class="w-4 h-4"><label class="text-xs">Use Polling</label></div></div></div></div><div class="card p-6 rounded-2xl space-y-4"><div><h3 class="font-bold mb-4">Ignore Patterns</h3><textarea id="s-ignore" rows="3" class="w-full p-3" placeholder="*.tmp, .DS_Store"></textarea></div></div></div><div class="sticky bottom-10 flex justify-center"><button type="submit" class="bg-blue-600 px-12 py-4 rounded-full font-bold text-white shadow-xl">Sync Settings</button></div></form></div></div></main><nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-[#0c111d]/90 backdrop-blur-xl border-t border-slate-800 flex justify-around p-3 z-50 shadow-2xl"><button onclick="switchTab('dashboard')" id="mn-dashboard" class="mobile-nav-link w-16 active"><i class="fas fa-chart-line text-lg mb-1"></i><span class="text-[9px] font-bold uppercase">Dash</span></button><button onclick="switchTab('health')" id="mn-health" class="mobile-nav-link w-16"><i class="fas fa-heart-pulse text-lg mb-1"></i><span class="text-[9px] font-bold uppercase">Health</span></button><button onclick="switchTab('logs')" id="mn-logs" class="mobile-nav-link w-16"><i class="fas fa-terminal text-lg mb-1"></i><span class="text-[9px] font-bold uppercase">Logs</span></button><button onclick="switchTab('browser')" id="mn-browser" class="mobile-nav-link w-16"><i class="fas fa-folder-tree text-lg mb-1"></i><span class="text-[9px] font-bold uppercase">Files</span></button><button onclick="switchTab('settings')" id="mn-settings" class="mobile-nav-link w-16"><i class="fas fa-sliders text-lg mb-1"></i><span class="text-[9px] font-bold uppercase">Config</span></button></nav><script>let currentTab = 'dashboard', initialConfigLoaded = false, browserPath = ""; window.hO = 0; window.hM = true; window.hL = false; window.switchTab = function(t) { currentTab = t; document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); document.querySelectorAll('.mobile-nav-link').forEach(l => l.classList.remove('active')); const d = document.getElementById('nav-'+t); if(d) d.classList.add('active'); const md = document.getElementById('mn-'+t); if(md) md.classList.add('active'); ['dashboard', 'health', 'history', 'settings', 'browser', 'logs'].forEach(v => document.getElementById('view-'+v).classList.add('hidden')); document.getElementById('view-'+t).classList.remove('hidden'); document.getElementById('page-title').innerText = t === 'logs' ? 'Live Logs' : t.charAt(0).toUpperCase() + t.slice(1); if(t === 'browser') loadBrowser(browserPath); if(t === 'logs') connectLogs(); if(t === 'history') loadHistory(); }; window.selectP = function(type) { document.getElementById('s-type').value = type; document.querySelectorAll('[id^="c-"]').forEach(c => c.style.borderColor = "transparent"); const c = document.getElementById('c-'+type); if(c) c.style.borderColor = "#0ea5e9"; document.getElementById('f-gen').classList.toggle('hidden', type === 'plex'); }; window.triggerFullScan = async function() { const btn = document.getElementById('btn-scan-all'); btn.disabled = true; try { await fetch('/api/scan-all', { method: 'POST' }); } catch(e) {} setTimeout(() => btn.disabled = false, 5000); }; window.testDiscord = async function() { const btn = document.querySelector('button[onclick="testDiscord()"]'), old = btn.innerText; btn.innerText = "..."; try { const res = await fetch('/api/test-webhook', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({url: document.getElementById('s-webhook').value}) }); if(res.ok) btn.innerText = "OK"; else btn.innerText = "Fail"; } catch(e) { btn.innerText = "Fail"; } setTimeout(() => btn.innerText = old, 2000); }; window.verifyPaths = async function() { const div = document.getElementById('path-errors'); div.innerHTML = "Checking..."; try { const res = await fetch('/api/validate-paths', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({paths: document.getElementById('s-dirs').value}) }); const data = await res.json(); div.innerHTML = ""; data.results.forEach(r => { if(!r.valid) div.innerHTML += `<p class="text-[10px] text-red-400 font-bold"><i class="fas fa-triangle-exclamation mr-1"></i> Invalid: ${r.path}</p>`; }); if(div.innerHTML === "") div.innerHTML = '<p class="text-[10px] text-green-400 font-bold">All paths valid</p>'; } catch(e) { div.innerHTML = "Error checking paths"; } setTimeout(() => div.innerHTML = "", 5000); }; window.checkServer = async function() { const btn = document.getElementById('btn-check-server'); const stat = document.getElementById('server-status'); const prov = document.getElementById('provider-name'); btn.classList.add('fa-spin'); try { const res = await fetch('/api/check-connection', { method: 'POST' }); const data = await res.json(); if(data.status === 'success') { stat.innerText = "Active"; stat.className = "text-green-500 text-[10px] font-bold uppercase"; if(data.message) prov.innerText = data.message; } else { stat.innerText = "Error"; stat.className = "text-red-500 text-[10px] font-bold uppercase"; } } catch(e) { stat.innerText = "Offline"; stat.className = "text-red-500 text-[10px] font-bold uppercase"; } setTimeout(() => btn.classList.remove('fa-spin'), 1000); }; window.clearHistory = async function(btn) { if(!btn.dataset.confirm) { btn.dataset.confirm = "true"; const old = btn.innerHTML; btn.innerHTML = '<i class="fas fa-question text-white animate-pulse"></i>'; btn.classList.add('bg-red-600'); setTimeout(() => { delete btn.dataset.confirm; btn.innerHTML = old; btn.classList.remove('bg-red-600'); }, 3000); return; } try { await fetch('/api/history/clear', { method: 'POST' }); loadHistory("", false); } catch(e) {} }; window.searchBrowser = function() {
    const path = document.getElementById('browser-search-input').value.trim();
    if(path) loadBrowser(path);
};

async function loadBrowser(path = "") { try { const res = await fetch('/api/browser/list?path='+encodeURIComponent(path)), data = await res.json(); if(data.error) return; browserPath = data.current_path; document.getElementById('browser-current-path').innerText = browserPath || "Root"; const list = document.getElementById('browser-list'); list.innerHTML = ''; data.items.forEach(item => { const card = document.createElement('div'); card.className = "card p-4 rounded-xl flex items-center gap-4 cursor-pointer"; card.onclick = () => item.is_dir ? loadBrowser(item.path) : null; card.innerHTML = `<div><i class="fas ${item.is_dir?'fa-folder text-blue-400':'fa-file-video text-slate-500'}"></i></div><div class="overflow-hidden flex-grow"><p class="text-xs font-bold truncate">${item.name}</p><div class="flex justify-between items-center mt-1"><span class="text-[9px] text-slate-500">${item.size_fmt}</span><span class="text-[9px] text-slate-600">${item.date}</span></div></div>${item.is_dir && !item.is_back ? `<button onclick="scanPath(this, '${item.path.replace(/'/g, "\\'")}')" class="w-8 h-8 rounded-lg bg-slate-800 hover:bg-blue-500 hover:text-white text-slate-400 transition-colors ml-2 flex-shrink-0 flex items-center justify-center"><i class="fas fa-bolt text-[10px]"></i></button>` : ''}`; list.appendChild(card); }); } catch(e) {} } async function loadHistory(query = "", append = false) { if(window.hL || (!append && !window.hM && query === "")) return; if(!append) { window.hO = 0; window.hM = true; document.getElementById('history-table-body').innerHTML = ''; } window.hL = true; const type = document.getElementById('history-filter').value; const search = type ? type + " " + query : query; try { const res = await fetch(`/api/history?offset=${window.hO}&search=${encodeURIComponent(search.trim())}`); const data = await res.json(); const b = document.getElementById('history-table-body'); if(data.length < 50) window.hM = false; b.insertAdjacentHTML('beforeend', data.map(r => `<tr><td class="px-6 py-4 font-mono text-[10px]">${r[0]}</td><td class="px-6 py-4 font-bold text-xs">${r[1]}</td><td class="px-6 py-4 text-xs">${r[2]}</td><td class="px-6 py-4 text-[10px] font-black uppercase">${r[3]}</td></tr>`).join('')); window.hO += data.length; document.getElementById('history-more').classList.toggle('hidden', !window.hM); } catch(e) {} finally { window.hL = false; } } function getSettings() { 
    const c = window.currentConfig || {}; 
    return { 
        ...c, 
        server_type: document.getElementById('s-type').value, 
        plex_server: document.getElementById('s-p-url').value, 
        plex_token: document.getElementById('s-p-token').value, 
        server_url: document.getElementById('s-url').value, 
        api_key: document.getElementById('s-key').value, 
        scan_directories: document.getElementById('s-dirs').value, 
        scan_debounce: parseInt(document.getElementById('s-deb').value), 
        scan_workers: parseInt(document.getElementById('s-work').value), 
        notifications_enabled: document.getElementById('s-notifs').checked, 
        discord_webhook_url: document.getElementById('s-webhook').value,
        run_interval: parseInt(document.getElementById('s-interval').value),
        scan_since_days: parseInt(document.getElementById('s-since').value),
        run_on_startup: document.getElementById('s-startup').checked,
        incremental_scan: document.getElementById('s-inc').checked,
        health_check: document.getElementById('s-health').checked,
        symlink_check: document.getElementById('s-symlink').checked,
        ignore_samples: document.getElementById('s-samples').checked,
        min_duration: parseInt(document.getElementById('s-duration').value),
        use_polling: document.getElementById('s-poll').checked,
        start_time: document.getElementById('s-start-time').value,
        scan_delay: parseFloat(document.getElementById('s-delay').value),
        log_level: document.getElementById('s-loglevel').value,
        ignore_patterns: document.getElementById('s-ignore').value
    }; 
}
function showError(btn, msg) {
    let p = btn.parentNode.querySelector('.err-msg');
    if(p) p.remove();
    p = document.createElement('div');
    p.className = 'err-msg text-[10px] text-red-500 font-bold mt-2 uppercase tracking-wide';
    p.innerText = "Error: " + msg;
    btn.parentNode.appendChild(p);
    setTimeout(() => p.remove(), 5000);
}

window.testConnection = async function() { 
    const btn = document.querySelector('button[onclick="testConnection()"]'); 
    const old = btn.innerText; 
    btn.innerText = "..."; 
    btn.disabled = true; 
    let existingErr = btn.parentNode.querySelector('.err-msg'); if(existingErr) existingErr.remove();
    try { 
        const res = await fetch('/api/test-connection', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(getSettings()) }); 
        const json = await res.json(); 
        if(json.status === 'success') { 
            btn.innerText = "Linked!"; 
        } else { 
            btn.innerText = "Failed"; 
            if(json.message) showError(btn, json.message); 
        } 
    } catch(e) { 
        btn.innerText = "Error"; 
        console.error(e); 
        showError(btn, "Network Error");
    } 
    setTimeout(() => { btn.innerText = old; btn.disabled = false; }, 2000); 
};

window.saveSettings = async function(btn) {
    if(!btn) btn = document.querySelector('#settings-form button[type="submit"]');
    const old = btn.innerHTML; 
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...'; 
    btn.disabled = true; 
    let existingErr = btn.parentNode.querySelector('.err-msg'); if(existingErr) existingErr.remove();
    try { 
        const res = await fetch('/api/settings', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(getSettings()) }); 
        const json = await res.json(); 
        if(json.status === 'success') { 
            btn.innerText = "Saved!"; 
            setTimeout(() => btn.innerHTML = old, 2000);
        } else { 
            btn.innerText = "Error"; 
            if(json.error) showError(btn, json.error); 
            setTimeout(() => btn.innerHTML = old, 3000);
        } 
    } catch(e) { 
        btn.innerText = "Error"; 
        console.error(e); 
        showError(btn, "Network Error");
        setTimeout(() => btn.innerHTML = old, 3000);
    } 
    btn.disabled = false;
};

document.getElementById('settings-form').addEventListener('submit', async function(e) { 
    e.preventDefault(); 
    window.saveSettings(this.querySelector('button[type="submit"]'));
});
let ws; let pollingInterval; const strip = (s) => s.replace(/[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g, '');
function connectLogs() { if(pollingInterval) return; if(ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) return; const proto = window.location.protocol === 'https:' ? 'wss' : 'ws'; const url = `${proto}://${window.location.host}/ws/logs`; const term = document.getElementById('log-terminal'); const log = (msg, color='text-slate-500') => { const span = document.createElement('div'); span.className = `whitespace-pre-wrap break-all font-mono text-[10px] ${color}`; span.innerText = strip(msg); term.appendChild(span); term.scrollTop = term.scrollHeight; if(term.childElementCount > 1000) term.removeChild(term.firstChild); }; log(`>> Connecting to ${url}...`); ws = new WebSocket(url); ws.onopen = () => log(">> Connection Established", "text-green-400"); ws.onmessage = function(event) { let color = "text-slate-300"; if(event.data.includes("ERROR")) color = "text-red-400 font-bold"; else if(event.data.includes("WARNING")) color = "text-orange-400"; else if(event.data.includes("INFO")) color = "text-blue-300"; else if(event.data.includes("DEBUG")) color = "text-slate-500"; log(event.data, color); }; ws.onerror = (e) => log(">> Connection Error. Switching to Polling Mode...", "text-red-500"); ws.onclose = (e) => { if(e.code === 1006 || e.code === 1000) { ws = null; startPolling(log); } else { log(`>> Connection Closed (Code: ${e.code}). Retrying in 5s...`, "text-orange-500"); ws = null; setTimeout(connectLogs, 5000); } }; } function startPolling(logFunc) { if(pollingInterval) return; logFunc(">> Polling Mode Active", "text-blue-400 font-bold"); const poll = async () => { if(currentTab !== 'logs') { clearInterval(pollingInterval); pollingInterval = null; return; } try { const res = await fetch('/api/logs'); const logs = await res.json(); const term = document.getElementById('log-terminal'); term.innerHTML = ''; logs.forEach(l => { let color = "text-slate-300"; if(l.includes("ERROR")) color = "text-red-400 font-bold"; else if(l.includes("WARNING")) color = "text-orange-400"; else if(l.includes("INFO")) color = "text-blue-300"; else if(l.includes("DEBUG")) color = "text-slate-500"; const span = document.createElement('div'); span.className = `whitespace-pre-wrap break-all font-mono text-[10px] ${color}`; span.innerText = strip(l); term.appendChild(span); }); term.scrollTop = term.scrollHeight; } catch(e) {} }; poll(); pollingInterval = setInterval(poll, 2000); }
window.scanPath = async function(btn, path) { event.stopPropagation(); const old = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin text-[10px]"></i>'; try { const res = await fetch('/api/browser/action', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'scan', path: path}) }); if(res.ok) btn.innerHTML = '<i class="fas fa-check text-green-400 text-[10px]"></i>'; else btn.innerHTML = '<i class="fas fa-times text-red-400 text-[10px]"></i>'; } catch(e) { btn.innerHTML = '<i class="fas fa-exclamation text-red-400 text-[10px]"></i>'; } setTimeout(() => btn.innerHTML = old, 2000); };
window.scanLibrary = async function(btn, lid, name) { const old = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin text-[10px]"></i>'; try { const res = await fetch('/api/scan-library', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({library_id: lid}) }); const json = await res.json(); if(json.status === 'success') btn.innerHTML = '<i class="fas fa-check text-green-400 text-[10px]"></i>'; else btn.innerHTML = '<i class="fas fa-times text-red-400 text-[10px]"></i>'; } catch(e) { btn.innerHTML = '<i class="fas fa-exclamation text-red-400 text-[10px]"></i>'; } setTimeout(() => btn.innerHTML = old, 2000); };
window.filterHealth = function(status) { switchTab('history'); document.getElementById('history-filter').value = 'Health Check'; document.getElementById('history-search').value = status; loadHistory(status); };
async function updateStats() { try { const res = await fetch('/api/stats'), data = await res.json(); document.getElementById('uptime').innerText = data.uptime; if(currentTab === 'dashboard') { document.getElementById('watching-count').innerText = data.watching_count; document.getElementById('pending-count').innerText = data.pending.length; document.getElementById('health-check-count').innerText = data.health.total; document.getElementById('stat-healthy').innerText = data.health.stats.healthy; document.getElementById('stat-corrupt').innerText = data.health.stats.corrupt; document.getElementById('stat-timeout').innerText = data.health.stats.timeout; const tot = data.health.stats.healthy + data.health.stats.corrupt + data.health.stats.timeout; document.getElementById('stat-integrity').innerText = tot > 0 ? (data.health.stats.healthy/tot*100).toFixed(1)+"%" : "0%";
if(!window.healthChartInstance) { const ctx = document.getElementById('healthChart').getContext('2d'); window.healthChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['Healthy', 'Corrupt', 'Timeout'], datasets: [{ data: [0, 0, 0], backgroundColor: ['#22c55e', '#ef4444', '#f97316'], borderWidth: 0, cutout: '75%' }] }, options: { plugins: { legend: { display: false } }, maintainAspectRatio: false } }); } window.healthChartInstance.data.datasets[0].data = [data.health.stats.healthy, data.health.stats.corrupt, data.health.stats.timeout]; window.healthChartInstance.update(); document.getElementById('chart-total').innerText = tot; document.getElementById('queue-list').innerHTML = data.pending.map(p => `<div class="card p-3 rounded-xl flex justify-between text-xs font-bold"><span>${p.path}</span><span>${p.remaining}s</span></div>`).join(''); document.getElementById('watching-list').innerHTML = (data.watching_paths || []).map(p => `<div class="card p-3 rounded-xl text-[10px] font-bold truncate">${p}</div>`).join(''); document.getElementById('libraries-list').innerHTML = data.libraries.map(l => `<div class="card p-3 rounded-xl flex justify-between items-center"><div class="flex flex-col"><span class="text-xs font-bold text-white">${l.title}</span><span class="text-[9px] font-black uppercase text-slate-500">${l.type}</span></div><div class="flex items-center gap-3"><span class="text-xs font-mono text-blue-400 font-bold">${l.count.toLocaleString()}</span><button onclick="scanLibrary(this, '${l.id}', '${l.title.replace(/'/g, "\\'")}')" class="bg-blue-500/10 text-blue-400 w-6 h-6 rounded flex items-center justify-center hover:bg-blue-500 hover:text-white transition-all"><i class="fas fa-sync-alt text-[10px]"></i></button></div></div>`).join(''); document.getElementById('storage-container').innerHTML = data.storage.map(s => `<div class="card p-4 rounded-2xl"><div class="flex justify-between items-end mb-2"><span class="text-[10px] font-black uppercase text-slate-500">${s.path}</span><span class="text-xs font-bold text-white">${s.free} Free</span></div><div class="w-full bg-slate-800 rounded-full h-1.5"><div class="bg-blue-500 h-1.5 rounded-full" style="width: ${s.percent}%"></div></div></div>`).join(''); } if(currentTab === 'health') { const hList = document.getElementById('health-list'); if(data.health.recent.length === 0) { hList.innerHTML = '<div class="text-center text-slate-500 py-10">No recent health checks</div>'; } else { hList.innerHTML = data.health.recent.map(h => { let color = "text-slate-400"; if(h.status === 'Healthy') color = "text-green-400"; else if(h.status === 'Corrupt') color = "text-red-400"; else if(h.status === 'Timeout') color = "text-orange-400"; return `<div class="card p-4 rounded-xl flex justify-between items-center"><div><p class="text-xs font-bold text-white truncate max-w-md">${h.file}</p><p class="text-[9px] text-slate-500 font-mono mt-1">${h.time} | ${h.error || ''}</p></div><span class="text-[10px] font-black uppercase ${color}">${h.status}</span></div>`; }).join(''); } } if(!initialConfigLoaded && data.config) { const c = data.config; window.selectP(c.server_type);     document.getElementById('s-p-url').value = c.plex_server;
    document.getElementById('s-p-token').value = c.plex_token;
    document.getElementById('s-url').value = c.server_url;
    document.getElementById('s-key').value = c.api_key;
    document.getElementById('s-dirs').value = c.scan_directories; document.getElementById('s-deb').value = c.scan_debounce; document.getElementById('s-work').value = c.scan_workers; document.getElementById('s-webhook').value = c.discord_webhook_url; document.getElementById('s-notifs').checked = c.notifications_enabled; 
    document.getElementById('s-interval').value = c.run_interval; document.getElementById('s-since').value = c.scan_since_days; document.getElementById('s-startup').checked = c.run_on_startup; document.getElementById('s-inc').checked = c.incremental_scan;
    document.getElementById('s-health').checked = c.health_check; document.getElementById('s-symlink').checked = c.symlink_check; document.getElementById('s-samples').checked = c.ignore_samples; document.getElementById('s-duration').value = c.min_duration;
    document.getElementById('s-poll').checked = c.use_polling; document.getElementById('s-start-time').value = c.start_time || ""; document.getElementById('s-delay').value = c.scan_delay; document.getElementById('s-loglevel').value = c.log_level;
    document.getElementById('s-ignore').value = c.ignore_patterns;
    initialConfigLoaded = true; window.currentConfig = c; } } catch(e) {} } setInterval(updateStats, 2000); updateStats();</script></body></html>